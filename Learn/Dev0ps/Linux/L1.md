# хранение данных

Может быть файловым или блочным
На диске есть Файловая система. Все файлы состоят из блоков. Файловое хранилище оперирует файлами, блочное блоками.
Есть понятие объектного хранилища. Когда поиск файла по его ID. S3

Блочное хранилище прадставляет собой SSD подключен к ПК через SATA

# Фаловое хранилище NAS

Дефолтным протоколом является NFS
CIFS/SAMBA - у WINDOWS
FTP

# Блочное хранилище SAN

- Локальное хранилище
  Блочное хранилище прадставляет собой SSD подключен к ПК через SATA
- Сетевое хранилище
  Fiber Chanel
  FCoE
  FCIP
  iSCSI
  DAS - диск вставляется в материнскую плату и имеем доступ к хранилищуъ

# Пример работы по протоколу FC

При нескольких серверах, диски их них можно достать и объеденить в дисковую корзину (storage pool)
Выделенный объем диска для определенного сервера называется lun. Чтобы сервер смог прочитать эти 100ГБ Мы подключаем к адаптеру на сервере HBA через протокол FiberChanel кабель до FiberChanel коммутатора, а от него в контроллер хранилища Корзины дисков SC1.

В данном примере, сеть между сервером и хранилищем называется SAN.

Для повышения надежности у серверов есть 2 интерфейса HBA, которыми нужно подключиться ко второму FC коммутатору. При выходе одно все равно доступ остается.
Получается у нас есть 2 физически независимые друг от друга сети. SAN A и SAN B.

# Минусы таких технологий - очень дорогие

Коммутатор FC 100к $
HBA 3к$
Кабели дорогие

# Пример работы по пртоколу Ethernet

Вместо сетевой карты HBA у нас NIC. Оттуда ведется кабель в обычный интернет коммутатор. Для репликации в 2 коммутатора.
FCoE - попытка вендеров продавать дорогие устройства. То же самое тлько через ethernet. Сейчас эта технология мертва, так как нужны лицензии на коммутатор.
ISCSI - устанавливает TCP сессию с контроллером хранилища поверх протокола TCP.IP без необходимости коммутаторов.

# Терминология

Target - то, куда подключаемся
INITIATOR - откуда подключение
IQM - имя ISCSI

# Можно превратить обычный сервер в ISCSI TARGET

Для этого нужно установить Target CLI
на клиент ставим ISCSI initiator utils - софт, чтобы мы смогли использовать ISCSI.
ISCSI можно использовать как уже в работающей системе, так и до загрузки ОС.
Если использовать ДО, нужно чтобы BIOS поддерживал BOOT from ISCI и сетевой адаптер.

### Монтирование диска SCSI yf Centos 7

<!-- Проверяем наши диски -->

fdisk /dev/sdb
p
(d потом w мы удаляем и сохраняем. Если надо)

sudo yum instal targetcli

# Настройка SCSI

<!-- Заходим  в targetcli -->

targetcli

Видим 3 раздела. Данные хранятся в backstore
Мы должны настроить backstore (block) и iscsi

# Настройка backstore

cd /backstores/block
Если нажать tab будет список команд

<!-- Создаем хранилище -->

create name=DISK_50G dev=/dev/sdc1

<!-- Можно командой LS увидеть, что диски создались. -->
<!-- Выходим в основное меню и заходим  iscsi -->

cd ..
cd iscsi
create wwn=iqn.2021-03.ru.zelobit

# Появяются настройки

luns - луны, которые доступны клиентам таргета. Можно присоеденять диски и выдавать из.
acsl - аксесс лист. Нужно разрешать луны только определенным серверам.

<!-- Заходим в созданный LUN -->

cd iqn.2021-03.ru.zelobit/tpg1/luns
create /backstores/block/DISK_50G

# Настройка инициатора подключения

sudo yum instal targetcli
sudo apt install open-iscsi

<!-- Узнаем имя инициатора -->

cat /etc/iscsi/initiatorname.iscsi

<!-- Переходим на сервер, где настраиваем lun и присоединяем его к инициатору -->

create wwn=iqn.2004-10.com.ubuntu:01:84de25ddfc37

<!-- Проверяем, что все получилось -->

cd ..
ls
exit

# Проверяем рабочие сокеты на сервере, на котором диск

ss -tunal
iscsi слушает нас на порту 3260

<!-- Переходим на сервер инициатора -->

man iscsiadm

<!-- Копируем пример команды и меняем IP адрес -->

sudo iscsiadm --mode discoverydb --type sendtargets --portal 172.21.1.188 --discover

<!-- Если получили ошибку -->

iscsiadm: cannot make connection to 172.21.1.188: No route to host

<!-- То открываем порт на сервере iscsi -->

firewall-cmd --add-port=3260/tcp --permanent
systemctl reload firewalld

<!-- Выполняем вход с сервера инициатораъ -->

sudo iscsiadm --mode node --targetname iqn.2021-03.ru.zelobit --portal 172.21.1.188:3260 --login

<!-- Проверяем подключился ли наш диск -->

lsblk

<!-- Теперь мы можем его отформатировать в удобный формат -->

fdisk /dev/sdc
n > p > w

<!-- Создаем файловую систему -->

mkfs.ext4 /dev/sdc1

<!-- Создадим директорию и Примонтируем наш диск -->

mkdir /mnt/iscsi/
sudo mount /dev/sdc1 /mnt/iscsi

# Теория.

Мы можем подключить несколько сетевых интерфейсов и сделать запись А А или А В. Но это возможно если будет использоваться режим MULTIPATH. Он сообщает, что у нас один диск и несколько способов подключения
