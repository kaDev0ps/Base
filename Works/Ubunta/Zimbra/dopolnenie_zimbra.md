# Защита от СПАМа

На сервере уже работает amavis, устанавливать что-то еще не нужно. Выберите письмо, являющееся спамом, и в контекстном меню выберите «Показать оригинал». Найдите строки, которые начинаются на «X-Spam»:
Получается следующее: для каждого полученного письма сервер вычисляет его спам-рейтинг (X-Spam-Score: 1.46) и, если этот рейтинг выше определенного порога (required=6.6), помечает его как «спам» или сразу удаляет.
Раз имеется этот порог, значит его можно понизить, отправляя в спам больше писем.
В системе администрирования zimbra заходим в «Глобальные настройки» -> «AS/AV».
Здесь есть два полезных поля: «Процент удаления» и «Процент меток», по умолчанию они имеют значения 75 и 33. Значение 100% соответствует X-Spam-Score=20 (75%=15, 50%=10, 25%=5 и т.д. делением на 5). Если нужно порог 6.6 понизить до 4.5 — вместо 33 ставим 22 (4.5 \* 5 = 22.5). На своём сервере я установил эти значения в 50 для удаления писем и 20 (X-Spam-Score=4) для установки метки «спам». Не переусердствуйте, иначе… сами знаете что.

# В разделе Агент передачи сообщений

Добавляем черный список
psbl.surriel.com
Ставим галочки на проерку протокола в адресе
Ставим галочку на проверку Домена

<!-- Обновление правил в SpamAssassin -->

su - zimbra -c "zmlocalconfig -e antispam_enable_rule_updates=true"

su - zimbra -c "zmlocalconfig -e antispam_enable_restarts=true"

<!-- После перезапустим соответствующие службы: -->

su - zimbra -c "zmamavisdctl restart"

su - zimbra -c "zmmtactl restart"

<!-- Черные списки -->
<!-- Чтобы усилить защиту, разрешим проверку отправителя в черных списках: -->

su - zimbra -c 'zmprov mcf zimbraMtaRestriction "reject_rbl_client psbl.surriel.com"'

<!-- Настройка mynetworks -->

После установки Zimbra в опции postfix mynetworks может оказаться подсеть, в которой находится наш сервер. На практике, это приводит к возможности отправки сообщений без пароля, что в свою очередь, позволяет любому вирусу в нашей сети делать нелегальную рассылку.

Задаем для mynetworks только адрес локальной петли и адрес сервера:

su - zimbra -c 'zmprov ms m.snabavangard.ru zimbraMtaMyNetworks "127.0.0.0/8 10.200.202.147/32"'

- где 192.168.1.15 — IP-адрес нашего почтового сервера.

<!-- Перезапускаем postfix: -->

su - zimbra -c 'postfix reload'

# Блокировка по домену

<!-- Открываем для редактирования файл /opt/zimbra/conf/salocal.cf.in
Находим секцию # accept email from zimbra support and forumns
Добавляем блокируемый домен (например блокируем всю почту из домена com.ua) -->

blacklist_from \*.com.ua

<!-- Сохраняем файл и перезапускаем Zimbra командой от пользователя Zimbra: -->

su zimbra
zmcontrol stop && zmcontrol start

<!-- Таким же образом можно добавить домен, почту от которого нужно всегда пропускать (например почту от пользователей своего домена). В той же секции необходимо добавить -->

whitelist_from \*@zimbradomain.dom
