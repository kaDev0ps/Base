## Рекомендованный NTP Сервер

ntp.msk-ix.ru
194.190.168.1

# Меняем часовой пояс

cp /usr/share/zoneinfo/Europe/Moscow /etc/localtime

# Установка сервера

<!-- Устанавливаем ntp сервер следующей командой: -->

apt-get install ntp -y

<!-- Разрешаем автозапуск и стартуем сервис: -->

systemctl enable ntp || update-rc.d ntp defaults

systemctl start ntp || service ntp start

<!-- Настройка NTP
Открываем файл с настройками: -->

vi /etc/ntp.conf

<!-- Перезапускаем сервис: -->

systemctl restart ntp || service restart ntp

<!-- Если используется брандмауэр, добавляем правило: -->

iptables -I INPUT 1 -p udp --dport 123 -j ACCEPT

<!-- Дополнительные настройки
Настройка файла хранения логов: -->

logfile /var/log/ntp.log

<!-- Тестирование
Проверить состояние получения эталонного времени можно командой: -->

ntpq -p

<!-- Мы должны увидеть, примерно, следующее:

     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 ru.pool.ntp.org .POOL.          16 p    -   64    0    0.000    0.000   0.000
 ntp.ubuntu.com  .POOL.          16 p    -   64    0    0.000    0.000   0.000
*91.189.94.4     17.253.34.253    2 u   58   64  377   55.802    3.790   0.412
-91.189.91.157   132.246.11.231   2 u   56   64  377  113.456   -1.746   0.334
+91.189.89.198   192.53.103.108   2 u    1   64  377   54.595    4.229   0.608
+91.189.89.199   17.253.34.253    2 u   61   64  377   54.061    2.637   0.557

* где:

remote — адрес сервера времени, с которым синхронизируется наш сервер;
refid — вышестоящий сервер (с которым сервер из графы выше получает время);
st — уровень сервера (stratum);
t — пир (unicast или multicast);
when — когда последний раз сверялось время;
poll — периодичность синхронизации с этим сервером;
reach — состояние работоспособности. Если удалось произвести синхронизации восемь раз в подряд становится равным 377;
delay — время задержки;
offset — разница между нашим временем и временем на сервере; положительное — наши часы спешат, отрицательное — отстают;
jitter — смещение времени на удаленном сервере;
* — с этим сервером синхронизирует время наш ntpd;
+ — сервер можно использовать для сверки часов;
- — не рекомендован для синхронизации;
x — не доступен. -->
<!-- Проверить отдачу времени сервером можно введя команду на другом Linux: -->

ntpdate 192.168.0.15

<!-- Правильный ответ имеет следующий вид: -->

ntpdate[3576]: adjust time server 192.168.0.15 offset 0.017657 sec

<!-- * время было рассинхронизировано на 0.017657 секунд. -->

<!-- Отобразить текущее время можно командой: -->

date

<!-- Если после синхронизации время некорректно, настраиваем правильный часовой пояс: -->

cp /usr/share/zoneinfo/Europe/Moscow /etc/localtime

<!-- * московское время (GMT+3). -->

# Настройка клиента Linux

Для клиентов можно выбрать 2 стратегии настройки — с помощью ntp или утилиты ntpdate.

<!-- NTP
Устанавливаем ntp: -->

<!-- Ubuntu / Debian: -->

apt-get install ntp

<!-- В настройка /etc/ntp.conf в качестве сервера оставляем только наш локальный сервер, например: -->

vi /etc/ntp.confa
server 192.168.0.15

<!-- Остальные pool и server удаляем или комментируем. -->

<!-- Перезапускаем NTP: -->

systemctl restart ntp || service restart ntp

<!-- ntpdate

Утилита командной строки выполняет разовую синхронизацию. Чтобы автоматизировать процесс, добавляем задание в cron:

crontab -e

0 0 * * * /usr/sbin/ntpdate 192.168.0.15

* в данном примере задание будет выполняться раз в день в 00:00. /usr/sbin/ntpdate — полный путь расположения утилиты, в разных системах может быть разным — проверить стоит командой which ntpdate.

Настройка клиента Windows
В командной строке выполняем:

w32tm /config /manualpeerlist:"192.168.0.15,0x8" /syncfromflags:manual /update -->
