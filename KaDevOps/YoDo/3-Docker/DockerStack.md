# Автоматизированная сборка группы связанных контейнеров внутри роя/кластера выполняется с помощью механизма docker stack.

По сути Docker Stack это как раз интеграция Composer в Swarm. Даже синтаксис конфигурационных файлов почти тот же.
Сразу предупреждаю насчет конфигурационных файлов. В уроке про Docker мы подключали локальную папку в контейнер. Эта папка никуда не пробрасывается в кластере. Т.е. если ты используешь подобную конструкцию, то должен позаботиться о том, чтобы на всех нодах эта папка была откуда-то примонтирована (либо прямо из контейнера монтировать папку по nfs например).
Сейчас мы с тобой будем поднимать ту же финальную конфигурацию из докера - nginx + php-fpm + mysql

С учетом специфики роя/кластера хранилище с сайтом будет лежать на файлсервере и подключаться по nfs.

Для повторения эксперимента **тебе нужно настроить файлсервер и по nfs расшарить папку - пусть будет /docker/learning**
Я в уроке буду использовать эту. Ты же можешь ее поменять.

`sudo apt install nfs-kernel-server`
Для начала создайте общий каталог

`sudo mkdir /docker/learning -p`

Например, для нашей папки, если вы хотите разрешить к ней подключаться только с определённого IP адреса, эта строка может выглядеть вот так:

`sudo vi /etc/exports`

`/var/nfs 127.0.0.1(rw,sync,no_subtree_check)`

Можно разрешить только нужную подсеть, например:

`/var/nfs 192.168.0.0/24(rw,sync,no_subtree_check)`

Для того чтобы разрешить все адреса используйте подсеть 0.0.0.0/0 или символ *.

Поскольку мы создаем его с правами sudo, владельцем каталога будет пользователь root на хосте:

`ls -la /`
<!-- Для безопасности NFS преобразует любые операции root на клиенте в операции с учетными данными nobody:nogroup. В связи с этим, нам необходимо изменить владельца каталога для соответствия этим учетным данным.

`sudo chown nobody:nogroup /var/nfs/general`
Теперь мы готовы к экспорту каталога. -->

Для того чтобы все пользователи могли получить доступ ко всем файлам можно создать пользователя с UID 1001 и попросить NFS все запросы считать запросами от анонимного пользователя, а анонимному пользователю присвоить UID 1001. Это делается такими опциями:

`/var/nfs 127.0.0.1(rw,sync,all_squash,root_squash,anonuid=1001,anongid=1001)`

Когда все будет настроено, останется только обновить таблицу экспорта NFS:

` sudo exportfs -a`

В эту папку на файлсервере нужно будет сложить файлы сайта. Как минимум простенький index.php
Это будет общая папка с сайтом, доступная для изменений извне.

Образ nginxtest/user1 надо будет собрать на всех нодах, либо поместить в публичное хранилище, чтобы все ноды могли его скачать.
В идеале образ всегда должен лежать в общем хранилище. Иначе удобство резко становится не совсем и удобством =).

Ты можешь создать новый файл docker-compose.yml или же дополнить старый.
# Начнем мы с подключаемого хранилища. 

Если ты успел почитать дополнительную литературу по работе с docker-compose, то наверное знаешь, что хранилище можно объявить отдельно и подключать в каждый контейнер по имени.
Если ты еще не в курсе, то тебя ждет сюрприз =).
Вот такой вот кусок кода надо добавить в конец docker-compose.yml
<!-- 
volumes:

        mywww:

                driver_opts:

                        type: "nfs"

                        o: "addr=192.168.88.241,nolock,soft,rw"

                        device: ":/docker/learning" -->

Тут как видишь создается общее хранилище "mywww" и описываются параметры его подключения.

Каждому контейнеру добавляется еще один раздел для конфигурирования - deploy, где описывается сколько реплик надо запускать.
И меняем данные по подключению хранилища.
Вот так они станут выглядеть в результате:

<!-- 
version: "3"
services:
        mysql:
                deploy:
                       replicas: 1
                image: mysql
                ports:
                        - 3306:3306
                environment:
                        - MYSQL_ROOT_PASSWORD=vecrek
        nginx:
                deploy:
                        replicas: 2
                image: user1/nginxtest
                ports:
                        - 8009:80
                links:
                        - php
                volumes:
#                        - /home/ka/VS_code/Base/KaDevOps/YoDo/Docker/dockertest/www:/var/www
                        - mywww:/var/www
        php:
                image: macedigital/phpfpm
                volumes:
#                        - /home/ka/VS_code/Base/KaDevOps/YoDo/Docker/dockertest/www:/var/www
                        - mywww:/var/www
volumes:
        mywww:
                driver_opts:
                        type: "nfs"
                        o: "addr=172.21.0.14,nolock,soft,rw"
                        device: ":/docker/learning" -->
Сразу предупреждаю. Если хранилище по nfs недоступно, то будет создано хранилище типа local. Пустое. На каждой ноде свое.

Чтобы точно быть уверенным, что все смонтируется на всех нодах надо сделать:

`sudo apt install nfs-common`
Все настроил и установил? Тогда запускаем!

`sudo docker stack deploy --compose-file docker-compose.yml lnmp`

Мы запустили стэк сервисов из complose-файла docker-compose.yml

Этому стэку мы дали кодовое название lnmp.
Проверяем
`sudo docker stack ls`
`sudo docker service ls`

Давай теперь посмотрим как это выглядит с точки зрения более низкоуровневых инструментов:
на обеих нодах:
`sudo docker ps`
на мастер-ноде:
`sudo docker service ls`
`sudo docker ps`
`sudo docker stack ls`

И удаляется стэк аналогично другим сущностям докера.
`sudo docker stack rm lnmp`

Конечно же, как и всегда, это не полное подробное описание всех опций всех конфигов, но практический урок, дающий тебе смелость тыкать во все эти кнопочки и решать встающие перед тобой проблемы. Как минимум ты уже без труда сможешь диагностировать имеющиеся кластеры и поддерживать их в рабочем состоянии.