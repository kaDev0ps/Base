# [Домашнее задание](https://github.com/a-prokopyev-resume/virt-homeworks/tree/virt-11/06-db-04-postgresql) к [занятию 4. «PostgreSQL»](https://netology.ru/profile/program/bd-dev-27/lessons/275713/lesson_items/1477607)Эта работа выполнена аналогично работе [06-db-02-sql](../06-db-02-sql) в виде IaC с помощью моих самодельных скриптов, запуская которые необходимые задачи решаются за 1 минуту, начиная с поднятия контейнеров без начального состояния (volumes пустые) и заканчивая их полным удалением вместе с содержимым volumes: * Работа с СУБД и почти всеми контейнерами осуществляется моим скриптом: [dbms.sh](src/dbms.sh)  Для выполнения этой работы достаточно запустить мой скрипт [work4.sh](src/work4.sh), конец которого показан далее:```task1;task2;task3;task4;```Кроме того в данной работе я переписал скрипты, чтобы упростить и улучшить их работу: * Теперь больше ненужно указывать отдельно имя контейнера и тип СУБД, достаточно указать имя контейнера, совпадающее с именем сервиса. Скрипт сам определит тип используемой СУБД просто по названию контейнера до последнего символа - цифры, обозначающей номер сервиса, если их несколько с одинаковой СУБД внутри, например, pg1, pg2, pg3, my1, my2 и т.д. * Если вместо имени контейнера указан только тип СУБД (pg, my, etc.), то по умолчанию имя контейнера подразумевается добавление цифры 1 в конце имени типа СУБД, например: pg1, my1, etc. * Все .env файлы перемещены в каталог env, docker-compose обновлён до самой свежей версии и теперь поддерживает указание нескольких --env-file одновременно, что было недоступно с версией docker-compose из дистрибутива Debian. * Скрипты теперь дополнительно возвращают ошибку (если она произошла) от psql в виде своего exit code. * Запуск, остановка и полное удаление контейнера вместе с его состоянием добавлены в скрипт [dbms.sh](src/dbms.sh). * Улучшены отладочные сообщения, которые теперь содержат информацию об используемом в каждом вызове env (а это обычно пользователь и имя базы данных, к которым происходит подключение на текущем шаге скрипта), имени вызываемой функции и имени контейнера. * Много других изменений, в основном влияющих на внутреннюю логику работы скриптов. * [06-db-02-sql](../06-db-02-sql) переделана для совместимости с новой версией скриптов.Наверно этот проект можно оформить отдельно в виде относительно удобного стенда для экспериментов с различными СУБД, используя почти мгновенное создание копии рабочей СУБД через Docker Compose и мои скрипты для удобного и самое главное унифицированного однотипного управления любой (которые есть в нашем курсе обучения, т.е. ещё MySQL и возможно потом Elastic) поддерживаемой СУБД.## Задача 1Содержимое моего манифеста [docker-compose.yml](src/docker-compose.yml):```#===> Tested with:# Devuan Chimaera (like Debian v11)# Docker Compose version v2.23.0# docker.io             20.10.5+dfsg1-1+deb11u2 amd64# python3-docker        5.0.3-1~bpo11+1version: '3.8'name: dbms services:  pg1:    container_name: pg1    image: ${IMAGE_PG}    env_file: # used per service to pass variable into docker, but default .env is passed only to docker-compose for docker-compose.yml interpolation which does NOT replace environment section in the service      - env/common.env    environment: # It is better to define per service environment locally from external vars      - POSTGRES_USER=${DB_USER}      - POSTGRES_PASSWORD=${DB_PASSWORD}      - POSTGRES_DB=${DB_NAME}      - PGDATA=${CONT_DATA_DIR_PG}    ports:      - "5431:5432"    volumes:      - ${HOST_DATA_DIR}/pg1:/${CONT_DATA_DIR_PG}      - ${HOST_BACKUP_DIR}:${CONT_BACKUP_DIR}  pg2:    container_name: pg2    image: ${IMAGE_PG}    env_file:      - env/common.env    environment:       - POSTGRES_USER=${DB_USER}      - POSTGRES_PASSWORD=${DB_PASSWORD}      - POSTGRES_DB=${DB_NAME}      - PGDATA=${CONT_DATA_DIR_PG}    ports:      - "5432:5432"    volumes:      - ${HOST_DATA_DIR}/pg2:/${CONT_DATA_DIR_PG}      - ${HOST_BACKUP_DIR}:${CONT_BACKUP_DIR}  my1:    container_name: my1    image: ${IMAGE_MY}    env_file:      - env/common.env        environment:      - MYSQL_DATABASE=${DB_NAME}      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}    volumes:      - ${HOST_DATA_DIR}/my1:/${CONT_DATA_DIR_MY}      - ${HOST_BACKUP_DIR}:${CONT_BACKUP_DIR}/      - ${HOST_CONFIG_DIR}/my1:/etc/mysql/conf.d # ${CONT_CONFIG_DIR_mysql}    ports:     - "3306:3306"  my2:    container_name: my2    image: ${IMAGE_MY}    env_file:      - env/common.env        environment:      - MYSQL_DATABASE=${DB_NAME}      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}    volumes:      - ${HOST_DATA_DIR}/my2:/${CONT_DATA_DIR_MY}      - ${HOST_BACKUP_DIR}:${CONT_BACKUP_DIR}/      - ${HOST_CONFIG_DIR}/my2:/etc/mysql/conf.d # ${CONT_CONFIG_DIR_mysql}    ports:     - "3306:3306"  gui:    container_name: gui    image: adminer:4.8.1-standalone    command: php -S 0.0.0.0:8080 -t /var/www/html # to avoid IPv6 binding    restart: always    environment:      ADMINER_DEFAULT_SERVER: postgres    ports:      - "8080:8080"``` Содержимое функции task1:```task1(){        ./dbms.sh pg1 wipe;        ./dbms.sh pg1 start;        ./dbms.sh pg1 inspect;        ./dbms.sh pg1 wait_ready;        show_db_objects;}```Лог выполнения скрипта:```===> wipe(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:33:50 PM UTC:+++ docker-compose --env-file=env/docker-compose.env --env-file=env/super.env --env-file=env/common.env stop pg1[+] Stopping 1/1 ✔ Container pg1  Stopped                                                                                                                                                                                   1.3s Deleted Containers:a96926a17e58a50ce394459745073048087e550f56b7cdb714d4f023c72fe8afTotal reclaimed space: 0B===> start(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:33:55 PM UTC:+++ docker-compose --env-file=env/docker-compose.env --env-file=env/super.env --env-file=env/common.env up -d pg1[+] Building 0.0s (0/0)                                                                                                                                                                           docker:default[+] Running 1/1 ✔ Container pg1  Started                                                                                                                                                                                   0.7s ===> inspect(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:33:59 PM UTC:+++ docker inspect pg1            "Env": [                "CONT_BACKUP_DIR=/mnt/backup",                "POSTGRES_PASSWORD=super",                "POSTGRES_DB=super",                "PGDATA=/var/lib/postgresql/data/pgdata",                "POSTGRES_USER=super",                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/lib/postgresql/13/bin",                "GOSU_VERSION=1.16",                "LANG=en_US.utf8",                "PG_MAJOR=13",                "PG_VERSION=13.12-1.pgdg110+1"--                "com.docker.compose.project.environment_file": "/download/netology/env/docker-compose.env,/download/netology/env/super.env,/download/netology/env/common.env",                "com.docker.compose.project.working_dir": "/download/netology",                "com.docker.compose.service": "pg1",                "com.docker.compose.version": "2.23.0"            },            "StopSignal": "SIGINT"        },        "NetworkSettings": {            "Bridge": "",            "SandboxID": "0ce3d9b68119374577cc6af8abb1dd11984079d3891f5fe5e582d68cf50d2d02",            "HairpinMode": false,CONTAINER ID   IMAGE                     COMMAND                  CREATED         STATUS        PORTS                    NAMESa85197fa6746   postgres:13.12-bullseye   "docker-entrypoint.s…"   5 seconds ago   Up 1 second   0.0.0.0:5431->5432/tcp   pg12b54fc7b0ccd   adminer                   "entrypoint.sh php -…"   9 hours ago     Up 7 hours    0.0.0.0:8080->8080/tcp   gui===> wait_ready(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:00 PM UTC:/var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - no response ... waiting 1s ... /var/run/postgresql:5432 - accepting connections=====> Вывод списка команд:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:21 PM UTC:\?===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:21 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\?'Pager usage is off.General  \copyright             show PostgreSQL usage and distribution terms  \crosstabview [COLUMNS] execute query and display results in crosstab  \errverbose            show most recent error message at maximum verbosity  \g [(OPTIONS)] [FILE]  execute query (and send results to file or |pipe);                         \g with no arguments is equivalent to a semicolon  \gdesc                 describe result of query, without executing it  \gexec                 execute query, then execute each value in its result  \gset [PREFIX]         execute query and store results in psql variables  \gx [(OPTIONS)] [FILE] as \g, but forces expanded output mode  \q                     quit psql  \watch [SEC]           execute query every SEC secondsHelp  \? [commands]          show help on backslash commands  \? options             show help on psql command-line options  \? variables           show help on special variables  \h [NAME]              help on syntax of SQL commands, * for all commandsQuery Buffer  \e [FILE] [LINE]       edit the query buffer (or file) with external editor  \ef [FUNCNAME [LINE]]  edit function definition with external editor  \ev [VIEWNAME [LINE]]  edit view definition with external editor  \p                     show the contents of the query buffer  \r                     reset (clear) the query buffer  \s [FILE]              display history or save it to file  \w FILE                write query buffer to fileInput/Output  \copy ...              perform SQL COPY with data stream to the client host  \echo [-n] [STRING]    write string to standard output (-n for no newline)  \i FILE                execute commands from file  \ir FILE               as \i, but relative to location of current script  \o [FILE]              send all query results to file or |pipe  \qecho [-n] [STRING]   write string to \o output stream (-n for no newline)  \warn [-n] [STRING]    write string to standard error (-n for no newline)Conditional  \if EXPR               begin conditional block  \elif EXPR             alternative within current conditional block  \else                  final alternative within current conditional block  \endif                 end conditional blockInformational  (options: S = show system objects, + = additional detail)  \d[S+]                 list tables, views, and sequences  \d[S+]  NAME           describe table, view, sequence, or index  \da[S]  [PATTERN]      list aggregates  \dA[+]  [PATTERN]      list access methods  \dAc[+] [AMPTRN [TYPEPTRN]]  list operator classes  \dAf[+] [AMPTRN [TYPEPTRN]]  list operator families  \dAo[+] [AMPTRN [OPFPTRN]]   list operators of operator families  \dAp[+] [AMPTRN [OPFPTRN]]   list support functions of operator families  \db[+]  [PATTERN]      list tablespaces  \dc[S+] [PATTERN]      list conversions  \dC[+]  [PATTERN]      list casts  \dd[S]  [PATTERN]      show object descriptions not displayed elsewhere  \dD[S+] [PATTERN]      list domains  \ddp    [PATTERN]      list default privileges  \dE[S+] [PATTERN]      list foreign tables  \det[+] [PATTERN]      list foreign tables  \des[+] [PATTERN]      list foreign servers  \deu[+] [PATTERN]      list user mappings  \dew[+] [PATTERN]      list foreign-data wrappers  \df[anptw][S+] [PATRN] list [only agg/normal/procedures/trigger/window] functions  \dF[+]  [PATTERN]      list text search configurations  \dFd[+] [PATTERN]      list text search dictionaries  \dFp[+] [PATTERN]      list text search parsers  \dFt[+] [PATTERN]      list text search templates  \dg[S+] [PATTERN]      list roles  \di[S+] [PATTERN]      list indexes  \dl                    list large objects, same as \lo_list  \dL[S+] [PATTERN]      list procedural languages  \dm[S+] [PATTERN]      list materialized views  \dn[S+] [PATTERN]      list schemas  \do[S+] [PATTERN]      list operators  \dO[S+] [PATTERN]      list collations  \dp     [PATTERN]      list table, view, and sequence access privileges  \dP[itn+] [PATTERN]    list [only index/table] partitioned relations [n=nested]  \drds [PATRN1 [PATRN2]] list per-database role settings  \dRp[+] [PATTERN]      list replication publications  \dRs[+] [PATTERN]      list replication subscriptions  \ds[S+] [PATTERN]      list sequences  \dt[S+] [PATTERN]      list tables  \dT[S+] [PATTERN]      list data types  \du[S+] [PATTERN]      list roles  \dv[S+] [PATTERN]      list views  \dx[+]  [PATTERN]      list extensions  \dy[+]  [PATTERN]      list event triggers  \l[+]   [PATTERN]      list databases  \sf[+]  FUNCNAME       show a function's definition  \sv[+]  VIEWNAME       show a view's definition  \z      [PATTERN]      same as \dpFormatting  \a                     toggle between unaligned and aligned output mode  \C [STRING]            set table title, or unset if none  \f [STRING]            show or set field separator for unaligned query output  \H                     toggle HTML output mode (currently off)  \pset [NAME [VALUE]]   set table output option                         (border|columns|csv_fieldsep|expanded|fieldsep|                         fieldsep_zero|footer|format|linestyle|null|                         numericlocale|pager|pager_min_lines|recordsep|                         recordsep_zero|tableattr|title|tuples_only|                         unicode_border_linestyle|unicode_column_linestyle|                         unicode_header_linestyle)  \t [on|off]            show only rows (currently off)  \T [STRING]            set HTML <table> tag attributes, or unset if none  \x [on|off|auto]       toggle expanded output (currently off)Connection  \c[onnect] {[DBNAME|- USER|- HOST|- PORT|-] | conninfo}                         connect to new database (currently "super")  \conninfo              display information about current connection  \encoding [ENCODING]   show or set client encoding  \password [USERNAME]   securely change the password for a userOperating System  \cd [DIR]              change the current working directory  \setenv NAME [VALUE]   set or unset environment variable  \timing [on|off]       toggle timing of commands (currently off)  \! [COMMAND]           execute command in shell or start interactive shellVariables  \prompt [TEXT] NAME    prompt user to set internal variable  \set [NAME [VALUE]]    set internal variable, or list all if no parameters  \unset NAME            unset (delete) internal variableLarge Objects  \lo_export LOBOID FILE  \lo_import FILE [COMMENT]  \lo_list  \lo_unlink LOBOID      large object operations+++ return 0=====> Список баз данных:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:22 PM UTC:\l+===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:22 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\l+'Pager usage is off.                                                               List of databases   Name    | Owner | Encoding |  Collate   |   Ctype    | Access privileges |  Size   | Tablespace |                Description                 -----------+-------+----------+------------+------------+-------------------+---------+------------+-------------------------------------------- postgres  | super | UTF8     | en_US.utf8 | en_US.utf8 |                   | 7753 kB | pg_default | default administrative connection database super     | super | UTF8     | en_US.utf8 | en_US.utf8 |                   | 7901 kB | pg_default |  template0 | super | UTF8     | en_US.utf8 | en_US.utf8 | =c/super         +| 7753 kB | pg_default | unmodifiable empty database           |       |          |            |            | super=CTc/super   |         |            |  template1 | super | UTF8     | en_US.utf8 | en_US.utf8 | =c/super         +| 7753 kB | pg_default | default template for new databases           |       |          |            |            | super=CTc/super   |         |            | (4 rows)+++ return 0=====> Информация о подключении:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:23 PM UTC:\conninfo===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:23 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\conninfo'Pager usage is off.You are connected to database "super" as user "super" via socket in "/var/run/postgresql" at port "5432".+++ return 0=====> Список таблиц:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:24 PM UTC:\dtS===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:24 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\dtS'Pager usage is off.                  List of relations   Schema   |          Name           | Type  | Owner ------------+-------------------------+-------+------- pg_catalog | pg_aggregate            | table | super pg_catalog | pg_am                   | table | super pg_catalog | pg_amop                 | table | super pg_catalog | pg_amproc               | table | super pg_catalog | pg_attrdef              | table | super pg_catalog | pg_attribute            | table | super pg_catalog | pg_auth_members         | table | super pg_catalog | pg_authid               | table | super pg_catalog | pg_cast                 | table | super pg_catalog | pg_class                | table | super pg_catalog | pg_collation            | table | super pg_catalog | pg_constraint           | table | super pg_catalog | pg_conversion           | table | super pg_catalog | pg_database             | table | super pg_catalog | pg_db_role_setting      | table | super pg_catalog | pg_default_acl          | table | super pg_catalog | pg_depend               | table | super pg_catalog | pg_description          | table | super pg_catalog | pg_enum                 | table | super pg_catalog | pg_event_trigger        | table | super pg_catalog | pg_extension            | table | super pg_catalog | pg_foreign_data_wrapper | table | super pg_catalog | pg_foreign_server       | table | super pg_catalog | pg_foreign_table        | table | super pg_catalog | pg_index                | table | super pg_catalog | pg_inherits             | table | super pg_catalog | pg_init_privs           | table | super pg_catalog | pg_language             | table | super pg_catalog | pg_largeobject          | table | super pg_catalog | pg_largeobject_metadata | table | super pg_catalog | pg_namespace            | table | super pg_catalog | pg_opclass              | table | super pg_catalog | pg_operator             | table | super pg_catalog | pg_opfamily             | table | super pg_catalog | pg_partitioned_table    | table | super pg_catalog | pg_policy               | table | super pg_catalog | pg_proc                 | table | super pg_catalog | pg_publication          | table | super pg_catalog | pg_publication_rel      | table | super pg_catalog | pg_range                | table | super pg_catalog | pg_replication_origin   | table | super pg_catalog | pg_rewrite              | table | super pg_catalog | pg_seclabel             | table | super pg_catalog | pg_sequence             | table | super pg_catalog | pg_shdepend             | table | super pg_catalog | pg_shdescription        | table | super pg_catalog | pg_shseclabel           | table | super pg_catalog | pg_statistic            | table | super pg_catalog | pg_statistic_ext        | table | super pg_catalog | pg_statistic_ext_data   | table | super pg_catalog | pg_subscription         | table | super pg_catalog | pg_subscription_rel     | table | super pg_catalog | pg_tablespace           | table | super pg_catalog | pg_transform            | table | super pg_catalog | pg_trigger              | table | super pg_catalog | pg_ts_config            | table | super pg_catalog | pg_ts_config_map        | table | super pg_catalog | pg_ts_dict              | table | super pg_catalog | pg_ts_parser            | table | super pg_catalog | pg_ts_template          | table | super pg_catalog | pg_type                 | table | super pg_catalog | pg_user_mapping         | table | super(62 rows)+++ return 0=====> Описание содержимого таблиц:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:25 PM UTC:\dS+===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:25 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\dS+'Pager usage is off.                                           List of relations   Schema   |              Name               | Type  | Owner | Persistence |    Size    | Description ------------+---------------------------------+-------+-------+-------------+------------+------------- pg_catalog | pg_aggregate                    | table | super | permanent   | 56 kB      |  pg_catalog | pg_am                           | table | super | permanent   | 40 kB      |  pg_catalog | pg_amop                         | table | super | permanent   | 80 kB      |  pg_catalog | pg_amproc                       | table | super | permanent   | 64 kB      |  pg_catalog | pg_attrdef                      | table | super | permanent   | 8192 bytes |  pg_catalog | pg_attribute                    | table | super | permanent   | 456 kB     |  pg_catalog | pg_auth_members                 | table | super | permanent   | 40 kB      |  pg_catalog | pg_authid                       | table | super | permanent   | 48 kB      |  pg_catalog | pg_available_extension_versions | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_available_extensions         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_cast                         | table | super | permanent   | 48 kB      |  pg_catalog | pg_class                        | table | super | permanent   | 136 kB     |  pg_catalog | pg_collation                    | table | super | permanent   | 240 kB     |  pg_catalog | pg_config                       | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_constraint                   | table | super | permanent   | 48 kB      |  pg_catalog | pg_conversion                   | table | super | permanent   | 48 kB      |  pg_catalog | pg_cursors                      | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_database                     | table | super | permanent   | 48 kB      |  pg_catalog | pg_db_role_setting              | table | super | permanent   | 8192 bytes |  pg_catalog | pg_default_acl                  | table | super | permanent   | 8192 bytes |  pg_catalog | pg_depend                       | table | super | permanent   | 488 kB     |  pg_catalog | pg_description                  | table | super | permanent   | 376 kB     |  pg_catalog | pg_enum                         | table | super | permanent   | 0 bytes    |  pg_catalog | pg_event_trigger                | table | super | permanent   | 8192 bytes |  pg_catalog | pg_extension                    | table | super | permanent   | 48 kB      |  pg_catalog | pg_file_settings                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_foreign_data_wrapper         | table | super | permanent   | 8192 bytes |  pg_catalog | pg_foreign_server               | table | super | permanent   | 8192 bytes |  pg_catalog | pg_foreign_table                | table | super | permanent   | 8192 bytes |  pg_catalog | pg_group                        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_hba_file_rules               | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_index                        | table | super | permanent   | 64 kB      |  pg_catalog | pg_indexes                      | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_inherits                     | table | super | permanent   | 0 bytes    |  pg_catalog | pg_init_privs                   | table | super | permanent   | 56 kB      |  pg_catalog | pg_language                     | table | super | permanent   | 48 kB      |  pg_catalog | pg_largeobject                  | table | super | permanent   | 0 bytes    |  pg_catalog | pg_largeobject_metadata         | table | super | permanent   | 0 bytes    |  pg_catalog | pg_locks                        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_matviews                     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_namespace                    | table | super | permanent   | 48 kB      |  pg_catalog | pg_opclass                      | table | super | permanent   | 48 kB      |  pg_catalog | pg_operator                     | table | super | permanent   | 144 kB     |  pg_catalog | pg_opfamily                     | table | super | permanent   | 48 kB      |  pg_catalog | pg_partitioned_table            | table | super | permanent   | 8192 bytes |  pg_catalog | pg_policies                     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_policy                       | table | super | permanent   | 8192 bytes |  pg_catalog | pg_prepared_statements          | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_prepared_xacts               | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_proc                         | table | super | permanent   | 688 kB     |  pg_catalog | pg_publication                  | table | super | permanent   | 0 bytes    |  pg_catalog | pg_publication_rel              | table | super | permanent   | 0 bytes    |  pg_catalog | pg_publication_tables           | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_range                        | table | super | permanent   | 40 kB      |  pg_catalog | pg_replication_origin           | table | super | permanent   | 8192 bytes |  pg_catalog | pg_replication_origin_status    | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_replication_slots            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_rewrite                      | table | super | permanent   | 656 kB     |  pg_catalog | pg_roles                        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_rules                        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_seclabel                     | table | super | permanent   | 8192 bytes |  pg_catalog | pg_seclabels                    | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_sequence                     | table | super | permanent   | 0 bytes    |  pg_catalog | pg_sequences                    | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_settings                     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_shadow                       | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_shdepend                     | table | super | permanent   | 40 kB      |  pg_catalog | pg_shdescription                | table | super | permanent   | 48 kB      |  pg_catalog | pg_shmem_allocations            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_shseclabel                   | table | super | permanent   | 8192 bytes |  pg_catalog | pg_stat_activity                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_all_indexes             | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_all_tables              | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_archiver                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_bgwriter                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_database                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_database_conflicts      | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_gssapi                  | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_progress_analyze        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_progress_basebackup     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_progress_cluster        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_progress_create_index   | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_progress_vacuum         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_replication             | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_slru                    | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_ssl                     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_subscription            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_sys_indexes             | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_sys_tables              | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_user_functions          | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_user_indexes            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_user_tables             | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_wal_receiver            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_xact_all_tables         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_xact_sys_tables         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_xact_user_functions     | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stat_xact_user_tables        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_all_indexes           | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_all_sequences         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_all_tables            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_sys_indexes           | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_sys_sequences         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_sys_tables            | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_user_indexes          | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_user_sequences        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statio_user_tables           | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_statistic                    | table | super | permanent   | 248 kB     |  pg_catalog | pg_statistic_ext                | table | super | permanent   | 8192 bytes |  pg_catalog | pg_statistic_ext_data           | table | super | permanent   | 8192 bytes |  pg_catalog | pg_stats                        | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_stats_ext                    | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_subscription                 | table | super | permanent   | 8192 bytes |  pg_catalog | pg_subscription_rel             | table | super | permanent   | 0 bytes    |  pg_catalog | pg_tables                       | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_tablespace                   | table | super | permanent   | 48 kB      |  pg_catalog | pg_timezone_abbrevs             | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_timezone_names               | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_transform                    | table | super | permanent   | 0 bytes    |  pg_catalog | pg_trigger                      | table | super | permanent   | 8192 bytes |  pg_catalog | pg_ts_config                    | table | super | permanent   | 40 kB      |  pg_catalog | pg_ts_config_map                | table | super | permanent   | 56 kB      |  pg_catalog | pg_ts_dict                      | table | super | permanent   | 48 kB      |  pg_catalog | pg_ts_parser                    | table | super | permanent   | 40 kB      |  pg_catalog | pg_ts_template                  | table | super | permanent   | 40 kB      |  pg_catalog | pg_type                         | table | super | permanent   | 120 kB     |  pg_catalog | pg_user                         | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_user_mapping                 | table | super | permanent   | 8192 bytes |  pg_catalog | pg_user_mappings                | view  | super | permanent   | 0 bytes    |  pg_catalog | pg_views                        | view  | super | permanent   | 0 bytes    | (129 rows)+++ return 0=====> Выход из psql:===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:26 PM UTC:\q===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:26 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c '\q'Pager usage is off.+++ return 0```## Задача 2Содержимое функции task2:```task2(){        ./dbms.sh pg1 cmd super "CREATE DATABASE test_database";        wget --output-document=$HostBackupDir/$TestDumpFile  https://raw.githubusercontent.com/netology-code/virt-homeworks/master/06-db-04-postgresql/test_data/test_dump.sql;        ./dbms.sh pg1 cmd2 admin -f /mnt/backup/$TestDumpFile;        ./dbms.sh pg1 cmd admin "\dt";        ./dbms.sh pg1 cmd admin "ANALYZE VERBOSE public.orders;"        ./dbms.sh pg1 cmd admin "SELECT avg_width FROM pg_stats WHERE tablename="\'orders\';}```Лог выполнения скрипта:```===> cmd(cont:=pg1, env:=super) at Tue 24 Oct 2023 02:34:27 PM UTC:CREATE DATABASE test_database===| Response [DB: super; U: super] at Tue 24 Oct 2023 02:34:27 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d super -c '\pset pager off' -c 'CREATE DATABASE test_database'Pager usage is off.CREATE DATABASE+++ return 0--2023-10-24 14:34:31--  https://raw.githubusercontent.com/netology-code/virt-homeworks/master/06-db-04-postgresql/test_data/test_dump.sqlResolving raw.githubusercontent.com (raw.githubusercontent.com)... 185.199.110.133, 185.199.111.133, 185.199.109.133, ...Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|185.199.110.133|:443... connected.HTTP request sent, awaiting response... 200 OKLength: 2082 (2.0K) [text/plain]Saving to: ‘./dbms_backup/test_dump.sql’./dbms_backup/test_dump.sql                          100%[===================================================================================================================>]   2.03K  --.-KB/s    in 0.001s  2023-10-24 14:34:32 (3.83 MB/s) - ‘./dbms_backup/test_dump.sql’ saved [2082/2082]===> cmd2(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:32 PM UTC:-f /mnt/backup/test_dump.sql===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:32 PM UTC:+++ docker exec -it pg1 psql -U super -d test_database -c '\pset pager off' -f /mnt/backup/test_dump.sqlPager usage is off.SETSETSETSETSET set_config ------------ (1 row)SETSETSETSETSETSETCREATE TABLEpsql:/mnt/backup/test_dump.sql:34: ERROR:  role "postgres" does not existCREATE SEQUENCEpsql:/mnt/backup/test_dump.sql:49: ERROR:  role "postgres" does not existALTER SEQUENCEALTER TABLECOPY 8 setval --------      8(1 row)ALTER TABLE+++ return 0===> cmd(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:33 PM UTC:\dt===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:33 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d test_database -c '\pset pager off' -c '\dt'Pager usage is off.        List of relations Schema |  Name  | Type  | Owner --------+--------+-------+------- public | orders | table | super(1 row)+++ return 0===> cmd(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:34 PM UTC:ANALYZE VERBOSE public.orders;===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:34 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d test_database -c '\pset pager off' -c 'ANALYZE VERBOSE public.orders;'Pager usage is off.INFO:  analyzing "public.orders"INFO:  "orders": scanned 1 of 1 pages, containing 8 live rows and 0 dead rows; 8 rows in sample, 8 estimated total rowsANALYZE+++ return 0===> cmd(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:35 PM UTC:SELECT avg_width FROM pg_stats WHERE tablename='orders'===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:35 PM UTC:+++ docker exec -it pg1 psql -v ON_ERROR_STOP=1 -U super -d test_database -c '\pset pager off' -c 'SELECT avg_width FROM pg_stats WHERE tablename='\''orders'\'''Pager usage is off. avg_width -----------         4        16         4(3 rows)+++ return 0```## Задача 3Содержимое функции task3:```task3(){        ./dbms.sh pg1 sql_file admin task3.sql;}```Содержимое файла [task3.sql](src/task3.sql), с помощью которого создаётся новая секционированная таблица NewOrders, данные из старой таблицы переносятся в новую, потом старая таблица удаляется, а новая переименовывается в соответствии со старым названием. Все операции выполняются в одном транзакционном блоке, чтобы в случае сбоя не появилось неконсистентности данных (недосозданные, частично удалённые и т.п.):```/* alternative to psql -v ON_ERROR_STOP=1 for tracking exit codes from psql*/\set ON_ERROR_STOP on START TRANSACTION;    CREATE TABLE IF NOT EXISTS NewOrders(ID SERIAL, Title VARCHAR(80) NOT NULL, Price INTEGER DEFAULT 0, PRIMARY KEY (ID, Price)) PARTITION BY RANGE (Price);    CREATE TABLE IF NOT EXISTS OrdersPart1 PARTITION OF NewOrders FOR VALUES FROM (MinValue) TO (500);    CREATE TABLE IF NOT EXISTS OrdersPart2 PARTITION OF NewOrders FOR VALUES FROM (500) TO (MaxValue);    INSERT INTO NewOrders SELECT * FROM Orders;    DROP TABLE Orders;    ALTER TABLE NewOrders RENAME TO Orders;COMMIT;```Партиционирование можно было сделать заранее при проектировании таблицы.Лог выполнения скрипта:```===> sql_file(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:36 PM UTC:==> SQL interpolation using [ENV: admin; DB_NAME: test_database; DB_USER: super]/* alternative to psql -v ON_ERROR_STOP=1 for tracking exit codes from psql*/\set ON_ERROR_STOP on START TRANSACTION;    CREATE TABLE IF NOT EXISTS NewOrders(ID SERIAL, Title VARCHAR(80) NOT NULL, Price INTEGER DEFAULT 0, PRIMARY KEY (ID, Price)) PARTITION BY RANGE (Price);    CREATE TABLE IF NOT EXISTS OrdersPart1 PARTITION OF NewOrders FOR VALUES FROM (MinValue) TO (500);    CREATE TABLE IF NOT EXISTS OrdersPart2 PARTITION OF NewOrders FOR VALUES FROM (500) TO (MaxValue);    INSERT INTO NewOrders SELECT * FROM Orders;    DROP TABLE Orders;    ALTER TABLE NewOrders RENAME TO Orders;COMMIT;===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:36 PM UTC:+++ docker exec -i pg1 psql -v ON_ERROR_STOP=1 -U super -d test_databaseSTART TRANSACTIONCREATE TABLECREATE TABLECREATE TABLEINSERT 0 8DROP TABLEALTER TABLECOMMIT+++ return 0```## Задача 4Содержимое функции task4:```task4(){        ./dbms.sh pg backup admin backup2;        echo "ALTER TABLE ORDERS ADD CONSTRAINT orders_tilte_unique UNIQUE(title);" >> $HostBackupDir/backup2.psql;}```В файл бэкапа в конце добавлен CONSTRAINT для обеспечения уникальности поля Title.Лог выполнения скрипта:```===> backup(cont:=pg1, env:=admin) at Tue 24 Oct 2023 02:34:37 PM UTC:===| Response [DB: test_database; U: super] at Tue 24 Oct 2023 02:34:37 PM UTC:+++ docker exec -it pg1 bash -lc '                        pg_dumpall --globals-only -U super > /mnt/backup/backup2.dumpall_globals;                        pg_dump --verbose --column-inserts --format=custom -U super -d test_database > /mnt/backup/backup2.pg_restore;                        pg_dump --verbose --column-inserts --format=plain -U super -d test_database > /mnt/backup/backup2.psql;                'pg_dump: last built-in OID is 16383pg_dump: reading extensionspg_dump: identifying extension memberspg_dump: reading schemaspg_dump: reading user-defined tablespg_dump: reading user-defined functionspg_dump: reading user-defined typespg_dump: reading procedural languagespg_dump: reading user-defined aggregate functionspg_dump: reading user-defined operatorspg_dump: reading user-defined access methodspg_dump: reading user-defined operator classespg_dump: reading user-defined operator familiespg_dump: reading user-defined text search parserspg_dump: reading user-defined text search templatespg_dump: reading user-defined text search dictionariespg_dump: reading user-defined text search configurationspg_dump: reading user-defined foreign-data wrapperspg_dump: reading user-defined foreign serverspg_dump: reading default privilegespg_dump: reading user-defined collationspg_dump: reading user-defined conversionspg_dump: reading type castspg_dump: reading transformspg_dump: reading table inheritance informationpg_dump: reading event triggerspg_dump: finding extension tablespg_dump: finding inheritance relationshipspg_dump: reading column info for interesting tablespg_dump: finding the columns and types of table "public.orders"pg_dump: finding default expressions of table "public.orders"pg_dump: finding the columns and types of table "public.orderspart1"pg_dump: finding default expressions of table "public.orderspart1"pg_dump: finding the columns and types of table "public.orderspart2"pg_dump: finding default expressions of table "public.orderspart2"pg_dump: flagging inherited columns in subtablespg_dump: reading partitioning datapg_dump: reading indexespg_dump: reading indexes for table "public.orders"pg_dump: reading indexes for table "public.orderspart1"pg_dump: reading indexes for table "public.orderspart2"pg_dump: flagging indexes in partitioned tablespg_dump: reading extended statisticspg_dump: reading constraintspg_dump: reading foreign key constraints for table "public.orders"pg_dump: reading triggerspg_dump: reading rewrite rulespg_dump: reading policiespg_dump: reading row-level security policiespg_dump: reading publicationspg_dump: reading publication membershippg_dump: reading subscriptionspg_dump: reading large objectspg_dump: reading dependency datapg_dump: saving encoding = UTF8pg_dump: saving standard_conforming_strings = onpg_dump: saving search_path = pg_dump: saving database definitionpg_dump: last built-in OID is 16383pg_dump: reading extensionspg_dump: identifying extension memberspg_dump: reading schemaspg_dump: reading user-defined tablespg_dump: reading user-defined functionspg_dump: reading user-defined typespg_dump: reading procedural languagespg_dump: reading user-defined aggregate functionspg_dump: reading user-defined operatorspg_dump: reading user-defined access methodspg_dump: reading user-defined operator classespg_dump: reading user-defined operator familiespg_dump: reading user-defined text search parserspg_dump: reading user-defined text search templatespg_dump: reading user-defined text search dictionariespg_dump: reading user-defined text search configurationspg_dump: reading user-defined foreign-data wrapperspg_dump: reading user-defined foreign serverspg_dump: reading default privilegespg_dump: reading user-defined collationspg_dump: reading user-defined conversionspg_dump: reading type castspg_dump: reading transformspg_dump: reading table inheritance informationpg_dump: reading event triggerspg_dump: finding extension tablespg_dump: finding inheritance relationshipspg_dump: reading column info for interesting tablespg_dump: finding the columns and types of table "public.orders"pg_dump: finding default expressions of table "public.orders"pg_dump: finding the columns and types of table "public.orderspart1"pg_dump: finding default expressions of table "public.orderspart1"pg_dump: finding the columns and types of table "public.orderspart2"pg_dump: finding default expressions of table "public.orderspart2"pg_dump: flagging inherited columns in subtablespg_dump: reading partitioning datapg_dump: reading indexespg_dump: reading indexes for table "public.orders"pg_dump: reading indexes for table "public.orderspart1"pg_dump: reading indexes for table "public.orderspart2"pg_dump: flagging indexes in partitioned tablespg_dump: reading extended statisticspg_dump: reading constraintspg_dump: reading foreign key constraints for table "public.orders"pg_dump: reading triggerspg_dump: reading rewrite rulespg_dump: reading policiespg_dump: reading row-level security policiespg_dump: reading publicationspg_dump: reading publication membershippg_dump: reading subscriptionspg_dump: reading large objectspg_dump: reading dependency datapg_dump: saving encoding = UTF8pg_dump: saving standard_conforming_strings = onpg_dump: saving search_path = pg_dump: creating TABLE "public.orders"pg_dump: creating SEQUENCE "public.neworders_id_seq"pg_dump: creating SEQUENCE OWNED BY "public.neworders_id_seq"pg_dump: creating TABLE "public.orderspart1"pg_dump: creating TABLE "public.orderspart2"pg_dump: creating DEFAULT "public.orders id"pg_dump: processing data for table "public.orderspart1"pg_dump: processing data for table "public.orderspart2"pg_dump: executing SEQUENCE SET neworders_id_seqpg_dump: creating CONSTRAINT "public.orders neworders_pkey"pg_dump: creating CONSTRAINT "public.orderspart1 orderspart1_pkey"pg_dump: creating CONSTRAINT "public.orderspart2 orderspart2_pkey"pg_dump: creating INDEX ATTACH "public.orderspart1_pkey"pg_dump: creating INDEX ATTACH "public.orderspart2_pkey"```