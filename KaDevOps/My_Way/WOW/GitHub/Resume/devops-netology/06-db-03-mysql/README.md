# [Домашнее задание](https://github.com/a-prokopyev-resume/virt-homeworks/tree/virt-11/06-db-03-mysql) к [занятию 3. «MySQL»](https://netology.ru/profile/program/bd-dev-27/lessons/275712/lesson_items/1477599)Первые три задачи этого задания выполнены с помощью Ansible. MySQL и Ansible находятся каждый в своих собственных контейнерах.Для оркестрации контейнерами используется docker-compose с манифестом [docker-compose.yml](src/docker-compose.yml), созданным мной ещё при решении задач предыдущих работ.Контейнер с Ansible пришлось тоже добавить в docker-compose.yml, чтобы он оказался в одной сети с контейнером MySQL, к которому он подключается с помощью соответствующих модулей для провизионинга баз данных и самой СУБД.Переменные из каталога env, которые используются в docker-compose и старых bash скриптах для предыдущих задач, теперь автоматически конвертируются в одномименные файлы (в json формате) в каталоге vars, такие файлы легче загрузить в Ansible в качестве переменных, чем обычные env файлы.Playbook состоит из нескольких частей, которые динамически включаются в него с помощью `include_tasks`:```---- hosts: localhost  gather_facts: no  connection: local  vars_files: # Load global variables only once before playbook execution    - vars/secrets.yml    - vars/docker-compose.env.json # converted from env to JSON by env2json.py script  collections: community.docker  tasks:    - name: ===> WORK_6_3       debug:        msg: 06-db-03-mysql    - name: Load env variables (dynamically at this point here) earlier converted from env to JSON by env2json.py script      include_vars:        file: vars/admin.env.json        name: AdminEnv    - name: Load user.env      include_vars:        file: vars/user.env.json        name: UserEnv    - include_tasks:        file: task1.yml      tags:      - task1    - include_tasks:        file: task2.yml      tags:      - task2    - include_tasks:        file: task3.yml      tags:      - task3```Кроме того задача 3 использует самодельную роль profiling, которая вызывается дважды со значениями переменной Engine для MyISAM и InnoDB.Лог начала выполнения главного playbook [play.yml(симлинк на 06-db-03-mysql.yml)](src/play.yml):```18:40 root@chimaera /download/netology 26:# > ./test.sh all+++ source lib.sh++++ ComposeEnv=' --env-file=env/docker-compose.env --env-file=env/super.env --env-file=env/common.env '+++ Action=start+++ MoreArgs='my1 gui iac'++++ date+++ echo -e '\n\n\n===> Debug at Fri 27 Oct 2023 06:40:26 PM UTC:'===> Debug at Fri 27 Oct 2023 06:40:26 PM UTC:+++ case $Action in+++ Services='my1 gui iac'+++ Options=' -d'+++ set -x+++ docker-compose --env-file=env/docker-compose.env --env-file=env/super.env --env-file=env/common.env -f /download/netology/docker-compose.yml up -d my1 gui iac[+] Building 0.0s (0/0)                                                                                                                                                                           docker:default[+] Running 3/3 ✔ Container gui  Running                                                                                                                                                                                   0.0s  ✔ Container iac  Running                                                                                                                                                                                   0.0s  ✔ Container my1  Running                                                                                                                                                                                   0.0s +++ docker ps -aCONTAINER ID   IMAGE                                        COMMAND                  CREATED          STATUS          PORTS                               NAMES6c83dcfc6929   mysql:8.0.34-debian                          "docker-entrypoint.s…"   48 minutes ago   Up 48 minutes   0.0.0.0:3306->3306/tcp, 33060/tcp   my12c25afe9c3b2   amd64/debian_iac:pip3_ansible_docker_mysql   "bash -lc 'sleep 10h'"   48 minutes ago   Up 48 minutes                                       iac0dd06b16c369   adminer:4.8.1-standalone                     "entrypoint.sh php -…"   27 hours ago     Up 27 hours     0.0.0.0:8080->8080/tcp              gui===> Executing command: docker exec  -ti  iac ansible-playbook play.yml[WARNING]: No inventory was parsed, only implicit localhost is available[WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'PLAY [localhost] ************************************************************************************************************************************************************************************************TASK [===> WORK_6_3] ********************************************************************************************************************************************************************************************ok: [localhost] => {    "msg": "06-db-03-mysql"}TASK [Load env variables (dynamically at this point here) earlier converted from env to JSON by env2json.py script] *********************************************************************************************ok: [localhost]TASK [Load user.env] ********************************************************************************************************************************************************************************************ok: [localhost]TASK [include_tasks] ********************************************************************************************************************************************************************************************included: /download/netology/task1.yml for localhost```## Задача 1Лог выполнения [task1.yml](src/task1.yml):```TASK [===> TASK_1. Create container and MySQL instance, restore database from a dump file, show some object inventory and help commands.] ***********************************************************************ok: [localhost] => {    "msg": "Используя Docker, поднимите инстанс MySQL (версию 8). Данные БД сохраните в volume.\nИзучите бэкап БД и восстановитесь из него.\nПерейдите в управляющую консоль mysql внутри контейнера.\nИспользуя команду \\h, получите список управляющих команд.\nНайдите команду для выдачи статуса БД и приведите в ответе из её вывода версию сервера БД.\nПодключитесь к восстановленной БД и получите список таблиц из этой БД.\nПриведите в ответе количество записей с price > 300."}TASK [Download database dump file] ******************************************************************************************************************************************************************************ok: [localhost]TASK [Restore database from downloaded file] ********************************************************************************************************************************************************************changed: [localhost]TASK [MySQL list of commands (output of help command)] **********************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result.stdout_lines": [        "?         (\\?) Synonym for `help'.",        "clear     (\\c) Clear the current input statement.",        "connect   (\\r) Reconnect to the server. Optional arguments are db and host.",        "delimiter (\\d) Set statement delimiter.",        "edit      (\\e) Edit command with $EDITOR.",        "ego       (\\G) Send command to mysql server, display result vertically.",        "exit      (\\q) Exit mysql. Same as quit.",        "go        (\\g) Send command to mysql server.",        "help      (\\h) Display this help.",        "nopager   (\\n) Disable pager, print to stdout.",        "notee     (\\t) Don't write into outfile.",        "pager     (\\P) Set PAGER [to_pager]. Print the query results via PAGER.",        "print     (\\p) Print current command.",        "prompt    (\\R) Change your mysql prompt.",        "quit      (\\q) Quit mysql.",        "rehash    (\\#) Rebuild completion hash.",        "source    (\\.) Execute an SQL script file. Takes a file name as an argument.",        "status    (\\s) Get status information from the server.",        "system    (\\!) Execute a system shell command.",        "tee       (\\T) Set outfile [to_outfile]. Append everything into given outfile.",        "use       (\\u) Use another database. Takes database name as argument.",        "charset   (\\C) Switch to another charset. Might be needed for processing binlog with multi-byte charsets.",        "warnings  (\\W) Show warnings after every statement.",        "nowarning (\\w) Don't show warnings after every statement.",        "resetconnection(\\x) Clean session context.",        "query_attributes Sets string parameters (name1 value1 name2 value2 ...) for the next query to pick up.",        "ssl_session_data_print Serializes the current SSL session data to stdout or file"    ]}TASK [MySQL connection information] *****************************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result.stdout_lines": [        "--------------",        "mysql  Ver 8.0.34 for Linux on x86_64 (MySQL Community Server - GPL)",        "",        "Connection id:\t\t89",        "Current database:\t",        "Current user:\t\troot@localhost",        "SSL:\t\t\tNot in use",        "Current pager:\t\tstdout",        "Using outfile:\t\t''",        "Using delimiter:\t;",        "Server version:\t\t8.0.34 MySQL Community Server - GPL",        "Protocol version:\t10",        "Connection:\t\tLocalhost via UNIX socket",        "Server characterset:\tutf8mb4",        "Db     characterset:\tutf8mb4",        "Client characterset:\tlatin1",        "Conn.  characterset:\tlatin1",        "UNIX socket:\t\t/var/run/mysqld/mysqld.sock",        "Uptime:\t\t\t46 min 46 sec",        "",        "Threads: 2  Questions: 215482  Slow queries: 3  Opens: 500  Flush tables: 3  Open tables: 391  Queries per second avg: 76.793",        "--------------"    ]}TASK [List of all MySQL databases] ******************************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result.stdout_lines": [        "Database",        "information_schema",        "mysql",        "performance_schema",        "super",        "sys",        "test_database"    ]}TASK [List of tables inside MySQL database test_database] *******************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result.stdout_lines": [        "Tables_in_test_database",        "orders"    ]}TASK [Amount of orders with price over 300] *********************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result.stdout_lines": [        "count(*)",        "1"    ]}```## Задача 2Лог выполнения [task2.yml](src/task2.yml):```TASK [include_tasks] ********************************************************************************************************************************************************************************************included: /download/netology/task2.yml for localhostTASK [===> TASK_2. Create new user, grant rights to him, show results] ******************************************************************************************************************************************ok: [localhost] => {    "msg": "Создайте пользователя test в БД c паролем test-pass, используя:\n    плагин авторизации mysql_native_password\n    срок истечения пароля — 180 дней\n    количество попыток авторизации — 3\n    максимальное количество запросов в час — 100\n    аттрибуты пользователя:\n        Фамилия \"Pretty\"\n        Имя \"James\".\nПредоставьте привелегии пользователю test на операции SELECT базы test_db.\nИспользуя таблицу INFORMATION_SCHEMA.USER_ATTRIBUTES, получите данные по пользователю test и приведите в ответе к задаче."}TASK [Create new MySQL user] ************************************************************************************************************************************************************************************ok: [localhost]TASK [Slightly update user permissions] *************************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "executed_queries": [            "ALTER USER 'test'@'%' PASSWORD EXPIRE INTERVAL 180 DAY  FAILED_LOGIN_ATTEMPTS 3 PASSWORD_LOCK_TIME 2;"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}TASK [Assign user attributes in JSON format to a variable] ******************************************************************************************************************************************************ok: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "msg": {        "fname": "James",        "lname": "Pretty"    }}TASK [Update user attributes] ***********************************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "executed_queries": [            "ALTER USER 'test'@'%'  ATTRIBUTE '{\"fname\": \"James\", \"lname\": \"Pretty\"}';"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}TASK [Show user permissions] ************************************************************************************************************************************************************************************ok: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SELECT * FROM INFORMATION_SCHEMA.USER_ATTRIBUTES WHERE USER='test';"        ],        "failed": false,        "query_result": [            [                {                    "ATTRIBUTE": "{\"fname\": \"James\", \"lname\": \"Pretty\"}",                    "HOST": "%",                    "USER": "test"                }            ]        ],        "rowcount": [            1        ]    }}```## Задача 3Для профилирования я создал функцию на SQL диалекте MySQL, определенную в файле [test_load.sql](src/test_load.sql), нагружающую MySQL. Профилирование пришлось включать глобально, потому что Ansible каждый раз открывает новую сессию для очередного запроса.Лог выполнения [task3.yml](src/task3.yml):```TASK [include_tasks] ********************************************************************************************************************************************************************************************included: /download/netology/task3.yml for localhostTASK [===> TASK_3. Profiling different engines (MyISAM and InnoDB)] *********************************************************************************************************************************************ok: [localhost] => {    "msg": "Установите профилирование SET profiling = 1. Изучите вывод профилирования команд SHOW PROFILES;.\nИсследуйте, какой engine используется в таблице БД test_db и приведите в ответе.\nИзмените engine и приведите время выполнения и запрос на изменения из профайлера в ответе:\n  на MyISAM,\n  на InnoDB."}TASK [Copy test_load.sql] ***************************************************************************************************************************************************************************************ok: [localhost]TASK [Create a function for load testing] ***********************************************************************************************************************************************************************changed: [localhost]TASK [debug] ****************************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "failed": false,        "rc": 0,        "stderr": "mysql: [Warning] Using a password on the command line interface can be insecure.",        "stderr_lines": [            "mysql: [Warning] Using a password on the command line interface can be insecure."        ],        "stdout": "",        "stdout_lines": []    }}TASK [include_role : profiling] *********************************************************************************************************************************************************************************TASK [profiling : =========> Starting profiling role for the following Engine] **********************************************************************************************************************************ok: [localhost] => {    "Engine": "InnoDB"}TASK [profiling : Set engine and enable profiling] **************************************************************************************************************************************************************changed: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "executed_queries": [            "ALTER TABLE orders ENGINE = InnoDB; SET GLOBAL profiling = 1;"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}TASK [profiling : Show choosen tables engines] ******************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SELECT TABLE_NAME, ENGINE FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'test_database';"        ],        "failed": false,        "query_result": [            [                {                    "ENGINE": "InnoDB",                    "TABLE_NAME": "orders"                }            ]        ],        "rowcount": [            1        ]    }}TASK [profiling : Make some load on the database] ***************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "select TestLoad();"        ],        "failed": false,        "query_result": [            [                {                    "TestLoad()": 1001                }            ]        ],        "rowcount": [            1        ]    }}TASK [profiling : Show profiles] ********************************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SHOW PROFILES;"        ],        "failed": false,        "query_result": [            [                {                    "Duration": 0.0016075,                    "Query": "SET NAMES utf8mb4",                    "Query_ID": 1                },                {                    "Duration": 0.00022275,                    "Query": "SET autocommit=0",                    "Query_ID": 2                },                {                    "Duration": 0.00029425,                    "Query": "SET autocommit=1",                    "Query_ID": 3                }            ]        ],        "rowcount": [            3        ]    }}TASK [profiling : Show profile details] *************************************************************************************************************************************************************************changed: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "failed": false,        "rc": 0,        "stderr": "mysql: [Warning] Using a password on the command line interface can be insecure.",        "stderr_lines": [            "mysql: [Warning] Using a password on the command line interface can be insecure."        ],        "stdout": "Status\tDuration\nstarting\t0.000184\nchecking permissions\t0.000014\nOpening tables\t0.000024\ninit\t0.000015\noptimizing\t0.000021\nexecuting\t0.000021\nend\t0.000014\nquery end\t0.000018\nclosing tables\t0.000012\nfreeing items\t0.000030\ncleaning up\t0.001113",        "stdout_lines": [            "Status\tDuration",            "starting\t0.000184",            "checking permissions\t0.000014",            "Opening tables\t0.000024",            "init\t0.000015",            "optimizing\t0.000021",            "executing\t0.000021",            "end\t0.000014",            "query end\t0.000018",            "closing tables\t0.000012",            "freeing items\t0.000030",            "cleaning up\t0.001113"        ]    }}TASK [profiling : Disabling global profiling] *******************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SET GLOBAL profiling = 0;"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}TASK [include_role : profiling] *********************************************************************************************************************************************************************************TASK [profiling : =========> Starting profiling role for the following Engine] **********************************************************************************************************************************ok: [localhost] => {    "Engine": "MyISAM"}TASK [profiling : Set engine and enable profiling] **************************************************************************************************************************************************************changed: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "executed_queries": [            "ALTER TABLE orders ENGINE = MyISAM; SET GLOBAL profiling = 1;"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}TASK [profiling : Show choosen tables engines] ******************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SELECT TABLE_NAME, ENGINE FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'test_database';"        ],        "failed": false,        "query_result": [            [                {                    "ENGINE": "MyISAM",                    "TABLE_NAME": "orders"                }            ]        ],        "rowcount": [            1        ]    }}TASK [profiling : Make some load on the database] ***************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "select TestLoad();"        ],        "failed": false,        "query_result": [            [                {                    "TestLoad()": 1001                }            ]        ],        "rowcount": [            1        ]    }}TASK [profiling : Show profiles] ********************************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SHOW PROFILES;"        ],        "failed": false,        "query_result": [            [                {                    "Duration": 0.0009525,                    "Query": "SET NAMES utf8mb4",                    "Query_ID": 1                },                {                    "Duration": 0.0001595,                    "Query": "SET autocommit=0",                    "Query_ID": 2                },                {                    "Duration": 0.00034625,                    "Query": "SET autocommit=1",                    "Query_ID": 3                }            ]        ],        "rowcount": [            3        ]    }}TASK [profiling : Show profile details] *************************************************************************************************************************************************************************changed: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": true,        "failed": false,        "rc": 0,        "stderr": "mysql: [Warning] Using a password on the command line interface can be insecure.",        "stderr_lines": [            "mysql: [Warning] Using a password on the command line interface can be insecure."        ],        "stdout": "Status\tDuration\nstarting\t0.000252\nchecking permissions\t0.000020\nOpening tables\t0.000034\ninit\t0.000021\noptimizing\t0.000026\nexecuting\t0.000027\nend\t0.000018\nquery end\t0.000023\nclosing tables\t0.000017\nfreeing items\t0.000048\ncleaning up\t0.006701",        "stdout_lines": [            "Status\tDuration",            "starting\t0.000252",            "checking permissions\t0.000020",            "Opening tables\t0.000034",            "init\t0.000021",            "optimizing\t0.000026",            "executing\t0.000027",            "end\t0.000018",            "query end\t0.000023",            "closing tables\t0.000017",            "freeing items\t0.000048",            "cleaning up\t0.006701"        ]    }}TASK [profiling : Disabling global profiling] *******************************************************************************************************************************************************************ok: [localhost]TASK [profiling : debug] ****************************************************************************************************************************************************************************************ok: [localhost] => {    "Result": {        "changed": false,        "executed_queries": [            "SET GLOBAL profiling = 0;"        ],        "failed": false,        "query_result": [            []        ],        "rowcount": [            0        ]    }}PLAY RECAP ******************************************************************************************************************************************************************************************************localhost                  : ok=59   changed=13   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  ```## Задача 4 Эту задачу я не успел автоматизировать в Ansible (но это было необязательно по условиям задачи, достаточно было сделать вручную, через Ansible дольше, если делать только один раз).- скорость IO важнее сохранности данных;- нужна компрессия таблиц для экономии места на диске;- размер буффера с незакомиченными транзакциями 1 Мб;- буффер кеширования 30% от ОЗУ;- размер файла логов операций 100 Мб.```[mysqld]# Скорость IO важнее сохранности данныхdefault-storage-engine=InnoDBinnodb_flush_log_at_trx_commit = 2# Размер буффера с незакомиченными транзакциями 1 Мбinnodb_log_buffer_size = 1M# Буффер кеширования 30% от ОЗУ# Если на сервере 32GB RAM, то треть - это примерно 10GBinnodb_buffer_pool_size=10G# Размер файла логов операций 100 Мбinnodb_log_file_size = 100М# Нужна компрессия таблиц для экономии места на дискеprotocol_compression_algorithms=zstd```